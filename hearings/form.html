<!DOCTYPE html>
<html>

<head>
    <title>Council Hearing Notice Form Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/jquery-ui.css">
    <!--  <link href="./css/style.css" rel="stylesheet">

      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
-->
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <form role="form" class="form" data-persist="garlic">
                    <fieldset>

                        <!-- Form Name -->
                        <legend>Hearing Notice Generator</legend>

                        <!-- Select Multiple -->
                        <div class="form-group">
                            <label class="form-label" for="committee_name">Committee Name</label>
                            <select class="form-control" multiple id="committee_name" name="committee_name">
                                <option>Committee on Business, Consumer, and Regulatory Affairs</option>
                                <option>Committee on Economic Development</option>
                                <option>Committee on Education</option>
                                <option>Committee on Finance and Revenue</option>
                                <option>Committee on Health</option>
                                <option>Committee on Human Services</option>
                                <option>Committee on Government Operations</option>
                                <option>Committee on the Judiciary and Public Safety</option>
                                <option>Committee on Transportation and the Environment</option>
                                <option>Committee of the Whole</option>
                            </select>
                        </div>

                        <!-- Select Basic -->
                        <div class="form-group">
                            <label class="form-label" for="councilmember">Committee Chair</label>
                            <select id="councilmember" multiple name="councilmember" class="form-control">
                                <option>Yvette Alexander</option>
                                <option>Marion Barry</option>
                                <option>Anita Bonds</option>
                                <option>Muriel Bowser</option>
                                <option>David Catania</option>
                                <option>Mary Cheh</option>
                                <option>Jack Evans</option>
                                <option>Jim Graham</option>
                                <option>David Grosso</option>
                                <option>Kenyan McDuffie</option>
                                <option>Phil Mendelson</option>
                                <option>Vincent Orange</option>
                                <option>Tommy Wells</option>
                            </select>
                        </div>

                        <hr/>
                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="address">Committee Address</label>
                            <input class="form-control" id="address" name="address" type="text" value="1350 Pennsylvania Avenue, N.W., Suite 119, Washington, DC 20004">
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="committee_phone">Committee Phone Number</label>
                            <input class="form-control" id="committee_phone" name="committee_phone" type="text" value="202-724-8000" required="">
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="committee_contact">Committee Contact Person</label>
                            <input class="form-control" id="committee_contact" name="committee_contact" type="text" value="" required="">
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="committee_contact_email">Committee Contact Email</label>
                            <input class="form-control" id="committee_contact_email" name="committee_contact_email" type="text" placeholder="" required="">
                        </div>

                        <hr/>

                        <!-- Select Basic -->
                        <div class="form-group">
                            <label class="form-label" for="hearing_type">Hearing/Roundtable</label>
                            <select class="form-control" id="hearing_type" name="hearing_type">
                                <option>hearing</option>
                                <option>oversight hearing</option>
                                <option>roundtable</option>
                                <option>oversight roundtable</option>
                            </select>
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="hearing_title">Hearing Title</label>
                            <input class="form-control" id="hearing_title" name="hearing_title" type="text" placeholder="" required="">
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="date">Date</label>
                            <input class="form-control" type="date" id="date" name="date" value="" required="">
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="time">Time</label>
                            <input class="form-control" id="time" name="time" type="time" value="10:00 am" required="">
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="room">Room Number</label>
                            <input class="form-control" id="room" name="room" type="text" value="Room 500" required="">
                        </div>

                        <!-- Textarea -->
                        <div class="form-group">
                            <label class="form-label" for="hearing_notice_body">Hearing Notice Body</label>
                            <textarea class="form-control" id="hearing_notice_body" name="hearing_notice_body" rows="8"></textarea>
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="witness_deadline">Witness Signup Deadline</label>
                            <input class="form-control" id="witness_deadline" name="witness_deadline" type="date" required="">
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="written_deadline">Written Testimony Deadline</label>
                            <input class="form-control" id="written_deadline" name="written_deadline" type="date" required="">
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="record_close">Record Close</label>
                            <input class="form-control" id="record_close" name="record_close" type="date" value="" required="">
                        </div>

                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="abbreviated">Abbreviated?</label>
                            <input class="form-control" id="abbreviated" name="abbreviated" type="text" value="">
                            <p class="help-block">Unless needed, leave blank.</p>
                        </div>


                        <!-- Text input-->
                        <div class="form-group">
                            <label class="form-label" for="revised">Revised?</label>
                            <input class="form-control" id="revised" name="revised" type="text" value="">
                            <p class="help-block">Unless needed, leave blank.</p>
                        </div>

                        <hr />


                        <!-- Additional options-->
                        <div class="form-group">
                            <label class="control-label">Additional Options</label>

                            <div class="checkbox">
                                <input type="checkbox" id="distribute_testimony" name="additional_options[]">Distribute Testimony?
                                <p class="help-block">Yes, if you distribute testimony before hearing.</p>
                            </div>
                            <div class="checkbox">
                                <input type="checkbox" id="less_time" name="additional_options[]">Less time if many witnesses?
                                <p class="help-block">Yes, if you opt to reduce the amount of time witnesses may testify.</p>
                            </div>
                        </div>

                        <!-- Select Basic -->
                        <div class="form-group">
                            <label class="form-label" for="testimony_rules">Testimony Rules?</label>
                            <select id="testimony_rules" name="testimony_rules" class="form-control">
                                <option>3 minutes for all</option>
                                <option selected="selected">5 minutes for organizations, 3 minutes for unaffiliated</option>
                            </select>
                        </div>


                        <div class="form-group">
                            <label class="form-label" for="testimony_copies">Copies of testimony?</label>
                            <input class="form-control" id="testimony_copies" name="testimony_copies" type="text" value="5">
                        </div>

                        <hr/>
                        <!-- Button (Double) -->
                        <div class="form-group" align="center">
                            <button type="button" id="submit_email" name="submit_email" class="btn btn-default" onclick="submitEmail()">Submit by Email</button>
                            <button type="button" id="preview_html" name="preview_html" class="btn btn-default" onclick="previewHTML()">Preview HTML</button>
                            <!--                            <button type="button" id="make_pdf" name="make_pdf" class="btn btn-default" onclick="makePDF()">Make a PDF</button>-->
                        </div>

                    </fieldset>
                </form>
            </div>

            <div class="col-md-6" id="rendered">

            </div>
        </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!--<script src="https://code.jquery.com/jquery.js"></script>-->
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="./js/jquery-1.9.1.js"></script>
    <script src="./js/jquery-ui.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/moment.min.js"></script>
    <script src="./js/garlic.js"></script>
    <script src="./js/marked.js"></script>
    <script src="./js/xregexp-min.js"></script>
    <script src="./js/lodash.compat.js"></script>
    <script src="./js/FileSaver.js"></script>
    <script type="text/javascript">
    var preview = '<h1>COUNCIL OF THE DISTRICT OF COLUMBIA<br /><%= committee_name %><br />NOTICE OF PUBLIC <%= hearing_type %></h1><%= address %><hr /><div id="abbreviated"><%= abbreviated_revised %></div><h2><%= councilmember %><br />CHAIR, <%= committee_name %><br />ANNOUNCES A PUBLIC <%= hearing_type %><br /></h2><div class="hearing">on</div><h2><%= hearing_title %></h2> <div class="hearing"><p>on</p><p><%= date %><br /><%= time %><br /><%= room %><br />1350 Pennsylvania Avenue NW<br />Washington, DC 20004</p></div> <div class="hearing-notice-body"> <p><%= councilmember %>, Chair of the <%= committee_name %>, announces a public <%= hearing_type %> of the <%= committee_name %>. The public <%= hearing_type %> will take place at <%= time %> on <%= date %> in <%= room %> of the John A. Wilson Building. <strong><%= abbreviated %> <%= revised %></strong></p> <p><%= hearing_notice_body %></p><p>Those who wish to testify are asked to telephone the <%= committee_name %> at <%= committee_phone %>, or e-mail <%= committee_contact %>, at <%= committee_contact_email %>, and furnish their name, address, telephone number, and organizational affiliation, if any, by the close of business on <%= witness_deadline %>. Persons wishing to testify are encouraged, but not required, to submit <%= testimony_copies %> copies of written testimony. <%= distribute_testimony %><%= witness_rules %><%= less_time %>.</p> <p>If you are unable to testify at the hearing, written statements are encouraged and will be made a part of the official record. Copies of written statements should be submitted to the <%= committee_name %>, Council of the District of Columbia, <%= address %>. The record will close at 5:00 p.m. on <%= record_close %>.</p>';

    function submitEmail() {
        var f = createJSONobj();
        var formObj = JSON.stringify(f, null, '\t');
        var blob = new Blob([formObj], {
            type: "text/json; charset=utf-8"
        });
        saveAs(blob, "hearing_notice_"+f["hearing_title"] + ".json");
        window.location.href = "mailto:evan.cash@gmail.com?subject=Hearing Notice: " + f["hearing_title"] + "&body=" + formObj;
    }

    function createJSONobj() {
        var out = {};
        $('.form-control').each(function(i) {
            out[$(this).attr("id")] = $(this).val();
        });
        $('input:checkbox:checked').each(function(i) {
            out[$(this).attr("id")] = ($(this).length > 0 ? true : false);
        })
        out["abbreviated_revised"] = [($("#abbreviated").val() == "" ? "" : "ABBREVIATED")];
        out["abbreviated_revised"].push(($("#revised").val() == "" ? "" : "REVISED"));

        return out;
    }

    function previewHTML() {
        var formObj = createJSONobj();
        formObj["date"] = moment(formObj.date).format("dddd, MMMM D, YYYY");
        formObj["time"] = moment(formObj.time, "h:m").format('h:mm a');
        formObj["witness_deadline"] = moment(formObj.witness_deadline).format("dddd, MMMM D, YYYY");
        formObj["written_deadline"] = moment(formObj.written_deadline).format("dddd, MMMM D, YYYY");
        formObj["record_close"] = moment(formObj.record_close).format("dddd, MMMM D, YYYY");
        formObj["distribute_testimony"] = (formObj["distribute_testimony"] ?
            formObj["distribute_testimony"] = "If submitted by the close of business on " + formObj["written_deadline"] + ", the testimony will be distributed to Councilmembers before the hearing." : "");
        formObj["less_time"] = (formObj["less_time"] ? "; less time will be allowed if there are a large number of witnesses" : "");
        formObj["witness_rules"] = ($("#witness_rules").val() == "3 minutes for all" ? "Witnesses should limit their testimony to three minutes" : "Persons representing organizations will have five minutes to present their testimony. Individuals will have three minutes to present their testimony");
        formObj["hearing_notice_body"] = marked(formObj["hearing_notice_body"]);

        $('#rendered').html(link2bills(_.template(preview, formObj)));
    }

    function link2bills(h) {
        // Regex is "BXX-XXX" or "PRXX-XXX" or "B XX-XXX"

        var reg = XRegExp('(?<type>(PR|Proposed Resolution)|(B|Bill))(\\s?)(?<period>\\d{1,2})(\\-)(?<number>\\d{1,4})', 'gi');
        return XRegExp.replace(h, reg, function(d) {

            // Bill or PR?
            var t = (d.type[0].toLowerCase() == "b" ? "B" : "PR");

            // Leading Zeros
            while (d.number.length < 4) {
                d.number = "0" + d.number;
            }

            //Build the URL
            var identifer = t + d.period + '-' + d.number;
            var url = 'http://dcclims1.dccouncil.us/lims/legislation.aspx?LegNo=' + identifer;

            //Return the Linked URL
            return linked(url, d);
        }, "all");

    }

    function linked(url, text) {
        return "<a href='" + url + "'>" + text + "</a>";
    }

    $("input[type='date']").datepicker();

    var committees = [{
        "committee": "Committee on Business, Consumer, and Regulatory Affairs",
        "chair": "Vincent Orange"
    }, {
        "committee": "Committee on Economic Development",
        "chair": "Muriel Bowser"
    }, {
        "committee": "Committee on Education",
        "chair": "David Catania"
    }, {
        "committee": "Committee on Finance and Revenue",
        "chair": "Jack Evans"
    }, {
        "committee": "Committee on Health",
        "chair": "Yvette Alexander"
    }, {
        "committee": "Committee on Human Services",
        "chair": "Jim Graham"
    }, {
        "committee": "Committee on Government Operations",
        "chair": "Kenyan McDuffie"
    }, {
        "committee": "Committee on the Judiciary and Public Safety",
        "chair": "Tommy Wells"
    }, {
        "committee": "Committee on Transportation and the Environment",
        "chair": "Mary Cheh"
    }, {
        "committee": "Committee of the Whole",
        "chair": "Phil Mendelson"
    }];

    $(document).ready(function() {
        $("#committee_name").change(function() {
            var cm = _.find(committees, {
                "committee": $("#committee_name").val()[0]
            });
            $("#councilmember").val(cm["chair"]);
        })

        //TODO: Work it out so that multiple committees actually render nicely (instead of "Muriel Bowser,Jack Evans, Chair of the Committee on Economic Development,Committee on Finance and Revenue, announces"... *shudder*)
        /*        $("#committee_name").change(function() {
            var cm = [];
            _.each($("#committee_name").val(), function (cmte) {
                return cm.push(_.find(committees, {
                    "committee": cmte
                })["chair"]);
            })

            $("#councilmember").val(cm);
        })
*/

        $("#date").change(function() {
            var t0 = moment($("#date").val());

            if (t0.weekday() == 1) {
                //Make sure that you're not asking for testimony on a Saturday or Sunday
                var t1 = t0.subtract('days',3).format("YYYY-MM-DD");        
            }
            else {
                //Any other day, get it the day before
                var t1 = t0.subtract('days', 1).format("YYYY-MM-DD");
            }
            var t2 = t0.add('days', 14).format("YYYY-MM-DD");
            $("#witness_deadline").val(t1);
            $("#written_deadline").val(t1);
            $("#record_close").val(t2);
        })
    })
    </script>
</body>

</html>
